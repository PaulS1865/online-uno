<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Idle Oil Rush</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
body{font-family:Arial;background:#f2f2f2;padding:15px}
.card{background:#fff;padding:15px;margin-bottom:10px;border-radius:10px}
button{padding:8px 12px;margin:4px;cursor:pointer}
</style>
</head>
<body>

<h1>üõ¢Ô∏è Idle Oil Rush</h1>
<button id="loginBtn">Login mit Google</button>

<div id="game" style="display:none">
  <h2>üåç Welten</h2>
  <div id="worlds"></div>
</div>

<script>
const supabaseClient = supabase.createClient(
  "https://wxlmxuranshgsarmtail.supabase.co",
  "sb_publishable_ChI55mbh48B05Mcd9yUqVg_sh9_MsDn"
);

let user = null;

// Login Button
document.getElementById("loginBtn").addEventListener("click", async () => {
  await supabaseClient.auth.signInWithOAuth({ provider: "google" });
});

// Auth-State Change
supabaseClient.auth.onAuthStateChange(async (_event, session) => {
  if (session?.user) {
    user = session.user;
    document.getElementById("game").style.display = "block";
    document.getElementById("loginBtn").style.display = "none";
    await loadWorlds();
    setInterval(tickAll, 5000);
  }
});

// Backend Call mit JWT
async function call(action, extra = {}) {
  if (!user) return;
  const token = user.access_token;
  const res = await supabaseClient.functions.invoke("node-api", {
    body: { action, playerId: user.id, ...extra },
    headers: { Authorization: `Bearer ${token}` }
  });
  if (res.error) console.error(res.error);
  return res.data;
}

// Tick alle 5s
async function tickAll() {
  const { data: worlds } = await supabaseClient
    .from("player_worlds").select("world_id").eq("player_id", user.id);
  if (!worlds) return;
  for (const w of worlds) await call("tick", { worldId: w.world_id });
  await loadWorlds();
}

// Lade Welten
async function loadWorlds() {
  const { data: owned } = await supabaseClient
    .from("player_worlds").select("*, world(*)").eq("player_id", user.id);
  const { data: all } = await supabaseClient.from("world").select();
  const container = document.getElementById("worlds");
  container.innerHTML = "";
  const ownedIds = owned.map(w => w.world_id);

  owned.forEach(w => {
    const d = document.createElement("div");
    d.className = "card";
    d.innerHTML = `
      <b>${w.world.name}</b><br>
      √ñl: ${Math.floor(w.oil)} | Geld: ${Math.floor(w.money)} | Prestige: ${w.prestige}<br>
      <button onclick="upgrade(${w.world_id})">Upgrade</button>
      <button onclick="sell(${w.world_id})">Verkaufen</button>
      <button onclick="prestige(${w.world_id})">Prestige</button>
    `;
    container.appendChild(d);
  });

  all.filter(w => !ownedIds.includes(w.id)).forEach(w => {
    const d = document.createElement("div");
    d.className = "card";
    d.innerHTML = `<b>${w.name}</b><br>Preis: ${w.base_price}<br>
      <button onclick="buyWorld(${w.id})">Kaufen</button>`;
    container.appendChild(d);
  });
}

// Globale Button Funktionen
window.upgrade  = id => call("upgrade",{ worldId:id }).then(loadWorlds);
window.sell     = id => call("sell",{ worldId:id }).then(loadWorlds);
window.prestige = id => call("prestige",{ worldId:id }).then(loadWorlds);
window.buyWorld = id => call("buyWorld",{ worldId:id }).then(loadWorlds);
</script>

</body>
</html>
